<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>å„¿ç«¥æ•…äº‹ç›´æ’­ï¼ˆCalliope + æ’ç”» + BGMï¼‰</title>
  <script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
  <style>
    body { font-family: "Microsoft YaHei", "PingFang SC", sans-serif; background:#fffaf0; padding:20px; }
    #controls { margin-bottom:12px; }
    textarea { width: 100%; height:70px; font-size:18px; }
    #startBtn { padding:10px 16px; font-size:18px; margin-top:8px; }
    #story { font-size:22px; line-height:1.8; background: #fff; padding:14px; border-radius:10px; box-shadow: 0 6px 18px rgba(0,0,0,0.06); max-height: 300px; overflow:auto; }
    #images { margin-top:12px; display:flex; gap:12px; align-items:flex-start; flex-wrap:wrap; }
    .story-img {
        width:320px; border-radius:12px; box-shadow:0 8px 20px rgba(0,0,0,0.12);
        opacity:0; transform: scale(0.95) rotate(-2deg);
        animation:fadeZoomIn 900ms ease forwards;
    }
    @keyframes fadeZoomIn {
      0% { opacity:0; transform: scale(0.95) rotate(-2deg); filter: blur(2px); }
      100% { opacity:1; transform: scale(1) rotate(0deg); filter: blur(0); }
    }
    #status { margin-top:8px; color:#666; }
  </style>
</head>
<body>
  <h1>ğŸ“– å„¿ç«¥æ•…äº‹ç›´æ’­ï¼ˆCalliopeï¼‰</h1>

  <div id="controls">
    <textarea id="prompt">ä»å‰æœ‰ä¸€åªå°å…”å­ï¼Œå®ƒéå¸¸å–œæ¬¢å†’é™©ã€‚</textarea><br>
    <button id="startBtn">å¼€å§‹è®²æ•…äº‹</button>
    <div id="status">å°±ç»ª</div>
  </div>

  <div id="story"></div>
  <div id="images"></div>

  <!-- èƒŒæ™¯éŸ³ä¹ï¼šè¯·æŠŠ mp3 æ”¾åˆ° static/bgm/warm_story.mp3 -->
  <audio id="bgm" loop>
    <source src="/static/bgm/warm_story.mp3" type="audio/mpeg" />
  </audio>

<script>
const socket = io();
const startBtn = document.getElementById("startBtn");
const storyDiv = document.getElementById("story");
const imagesDiv = document.getElementById("images");
const statusDiv = document.getElementById("status");
const bgm = document.getElementById("bgm");

let isPlayingAudio = false;

// åˆå§‹ BGM éŸ³é‡
bgm.volume = 0.55;
bgm.play().catch(()=>{ /* å¯èƒ½å› è‡ªåŠ¨æ’­æ”¾ç­–ç•¥è¢«é˜»æ­¢ï¼Œç”¨æˆ·ç‚¹å‡»åä¼šæ’­æ”¾ */ });

startBtn.onclick = () => {
  storyDiv.innerHTML = "";
  imagesDiv.innerHTML = "";
  const prompt = document.getElementById("prompt").value;
  socket.emit("start_story", { prompt });
  statusDiv.innerText = "è¯·æ±‚å·²å‘é€ï¼Œæ­£åœ¨ç”Ÿæˆ...";
  // ç¡®ä¿ BGM åœ¨ç”¨æˆ·äº¤äº’åæ’­æ”¾
  bgm.play().catch(()=>{});
};

// çŠ¶æ€ä¿¡æ¯
socket.on("status", (d)=> {
  statusDiv.innerText = d.msg || "";
});

// æ¯æ®µæ–‡å­—
socket.on("story_chunk", (d) => {
  const p = document.createElement("p");
  p.innerText = d.text;
  storyDiv.appendChild(p);
  storyDiv.scrollTop = storyDiv.scrollHeight;
});

// å›¾ç‰‡ï¼ˆbase64 pngï¼‰
socket.on("story_image", (d) => {
  const img = document.createElement("img");
  img.src = "data:image/png;base64," + d.image;
  img.className = "story-img";
  imagesDiv.appendChild(img);
  img.scrollIntoView({ behavior: "smooth", block: "center" });
});

// æ®µè½å¼€å§‹ï¼šé™ä½ BGMï¼ˆduckingï¼‰
socket.on("segment_start", (d) => {
  // ç¼“æ…¢é™ä½éŸ³é‡
  fadeVolume(bgm, bgm.volume, 0.18, 300);
});

// æ®µè½ç»“æŸï¼šæ¢å¤ BGM
socket.on("segment_end", (d) => {
  fadeVolume(bgm, bgm.volume, 0.55, 600);
});

// æ¥æ”¶éŸ³é¢‘ base64 -> æ’­æ”¾
socket.on("story_audio", (d) => {
  if (!d.audio_b64) return;
  const audioElm = new Audio("data:audio/mpeg;base64," + d.audio_b64);
  audioElm.play().catch(e => console.warn("æ’­æ”¾å¤±è´¥:", e));
  // å¯é€‰ï¼šå½“ audio æ’­æ”¾æ—¶åŠ ä¸€ä¸ªå°å›¾æ ‡æç¤ºï¼ˆæœªå®ç°ï¼‰
});

// å¹³æ»‘æ”¹å˜éŸ³é‡
function fadeVolume(audioElem, from, to, duration) {
  const steps = 12;
  const stepTime = duration / steps;
  const delta = (to - from) / steps;
  let cur = from;
  let i = 0;
  const t = setInterval(() => {
    i++;
    cur += delta;
    audioElem.volume = Math.max(0, Math.min(1, cur));
    if (i >= steps) {
      clearInterval(t);
      audioElem.volume = to;
    }
  }, stepTime);
}
</script>
</body>
</html>
