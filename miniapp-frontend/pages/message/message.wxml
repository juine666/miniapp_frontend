<view class="chat-container">
  <!-- ä¼šè¯åˆ—è¡¨æ¨¡å¼ -->
  <view wx:if="{{!showChat}}" class="conversation-list">
    <!-- ä¼šè¯åˆ—è¡¨ -->
    <scroll-view class="conversations-scroll" scroll-y enable-back-to-top="{{true}}">
      <view wx:for="{{conversations}}" wx:key="userId" class="conversation-item" catchtap="openConversation" data-userid="{{item.userId}}" data-productid="{{item.productId || ''}}">
        <image class="conversation-avatar" src="{{item.userAvatar || 'https://img.yzcdn.cn/vant/cat.jpeg'}}" mode="aspectFill"/>
        <view class="conversation-content">
          <view class="conversation-header">
            <view class="conversation-name">{{item.userName || 'ç”¨æˆ·'}}</view>
            <view class="conversation-time">{{item.timeStr}}</view>
          </view>
          <view class="conversation-message">
            <text class="message-preview">{{item.lastMessageContent}}</text>
            <view wx:if="{{item.unreadCount > 0}}" class="unread-badge">{{item.unreadCount > 99 ? '99+' : item.unreadCount}}</view>
          </view>
        </view>
        <view class="conversation-arrow">â€º</view>
      </view>
      
      <view wx:if="{{!conversations.length && !loading}}" class="empty-conversations">
        <view class="empty-icon">ğŸ’¬</view>
        <view class="empty-text">æš‚æ— æ¶ˆæ¯</view>
        <view class="empty-desc">ä¸‹è½½æ¶ˆæ¯å“Ÿï½</view>
      </view>
      
      <!-- åŠ è½½æ›´å¤šæç¤º -->
      <view wx:if="{{loading && conversations.length > 0}}" class="loading-more">
        <text>åŠ è½½ä¸­...</text>
      </view>
      <view wx:if="{{!hasMore && conversations.length > 0}}" class="no-more">
        <text>æ²¡æœ‰æ›´å¤šäº†</text>
      </view>
    </scroll-view>
  </view>

  <!-- èŠå¤©ç•Œé¢æ¨¡å¼ -->
  <view wx:else class="chat-view">
    <!-- è¿”å›æŒ‰é’® -->
    <view class="chat-header" bindtap="goBackToList">
      <text class="back-icon">â€¹</text>
      <text class="chat-title">èŠå¤©</text>
    </view>

    <!-- ä¸‹æ¶äº†ä»·æ ¼ä¿¡æ¯ -->
    <!-- <view wx:if="{{productInfo}}" class="product-card" bindtap="goToProductDetail">
      <image class="product-img" src="{{productInfo.coverUrl}}" mode="aspectFill"/>
      <view class="product-info">
        <view class="product-name">{{productInfo.name}}</view>
        <view class="product-price">ï¿¥{{productInfo.price}}</view>
      </view>
      <view class="product-arrow">â€º</view>
    </view> -->
    <view wx:if="{{productInfo}}" class="product-card" bindtap="goToProductDetail">
      <image class="product-img" src="{{productInfo.coverUrl}}" mode="aspectFill"/>
      <view class="product-info">
        <view class="product-name">{{productInfo.name}}</view>
        <!-- æ’æ²™ä¹°æ²™: ä¸‹æ¶äº†ä»·æ ¼ä¿¡æ¯ -->
      </view>
      <view class="product-arrow">â€º</view>
    </view>

    <!-- æ¶ˆæ¯åˆ—è¡¨ -->
    <scroll-view class="messages-list" scroll-y scroll-top="{{scrollTop}}" scroll-into-view="{{scrollIntoView}}" scroll-with-animation="{{true}}">
      <view wx:for="{{messages}}" wx:key="id" class="message-item {{item.fromUser == currentUserId ? 'sent' : 'received'}}">
        <!-- æ¥æ”¶çš„æ¶ˆæ¯æ˜¾ç¤ºå¤´åƒ -->
        <view wx:if="{{item.fromUser != currentUserId}}" class="avatar-wrapper avatar-wrapper-received">
          <image class="avatar" src="{{otherUserInfo.avatarUrl || 'https://img.yzcdn.cn/vant/cat.jpeg'}}" mode="aspectFill"/>
        </view>
        
        <view class="message-content">
          <view class="message-bubble {{item.fromUser == currentUserId ? 'sent-bubble' : 'received-bubble'}}">
            <text class="message-text">{{item.content}}</text>
          </view>
          <view class="message-time">{{item.timeStr || item.createdAt}}</view>
        </view>
        
        <!-- å‘é€çš„æ¶ˆæ¯æ˜¾ç¤ºå¤´åƒ -->
        <view wx:if="{{item.fromUser == currentUserId}}" class="avatar-wrapper avatar-wrapper-sent">
          <image class="avatar" src="{{currentUserInfo.avatarUrl || 'https://img.yzcdn.cn/vant/cat.jpeg'}}" mode="aspectFill"/>
        </view>
      </view>
      
      <view wx:if="{{!messages.length}}" class="empty-tip">
        <view class="empty-icon">ğŸ’¬</view>
        <view class="empty-text">æš‚æ— æ¶ˆæ¯ï¼Œå¼€å§‹èŠå¤©å§ï½</view>
      </view>
    </scroll-view>

    <!-- å¿«æ·å›å¤ï¼ˆå‚è€ƒé—²é±¼ï¼‰ -->
    <view wx:if="{{productInfo && !messages.length}}" class="quick-replies">
      <view class="quick-item" bindtap="sendQuickMessage" data-content="ä½ å¥½ï¼Œä½ æ˜¯å™œéªŒçš„ä½œè€…å—ï¼Ÿ">
        <text>æ˜¯ä½ å—ï¼Ÿ</text>
      </view>
      <view class="quick-item" bindtap="sendQuickMessage" data-content="æ€ä¹ˆæ¯”æƒ³ï¼Ÿ">
        <text>æœ‰æ„Ÿå—</text>
      </view>
      <view class="quick-item" bindtap="sendQuickMessage" data-content="èƒ½è¯¦ç»†æè¿°ä¸€ä¸‹å—ï¼Ÿ">
        <text>è¯¦ç»†ä¸€æ•´</text>
      </view>
    </view>

    <!-- è¾“å…¥æ¡† -->
    <view class="input-bar">
      <input class="input" placeholder="è¾“å…¥æ¶ˆæ¯..." value="{{inputContent}}" bindinput="onInput" confirm-type="send" bindconfirm="sendMessage" adjust-position="{{true}}"/>
      <view class="send-btn" bindtap="sendMessage">
        <text>å‘é€</text>
      </view>
    </view>
  </view>
</view>
