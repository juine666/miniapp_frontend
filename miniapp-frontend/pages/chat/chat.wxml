<view class="chat-container">
  <!-- æ ‡é¢˜æ  -->
  <view class="chat-header">
    <view class="back-btn" bindtap="goBack">
      <text>â†</text>
    </view>
    <view class="chat-title"></view>
    <view class="header-spacer"></view>
  </view>

  <!-- æ¶ˆæ¯åˆ—è¡¨ -->
  <scroll-view 
    class="messages-list" 
    scroll-y 
    scroll-into-view="{{toView}}"
    scroll-top="{{scrollTop}}"
    bindscrolltoupper="loadMore"
  >
    <view class="messages-inner">
      <view wx:for="{{messages}}" wx:key="index" class="message-item {{item.userId === currentUserId ? 'sent' : 'received'}}">
        <!-- æ¥æ”¶çš„æ¶ˆæ¯ -->
        <view wx:if="{{item.userId !== currentUserId}}" class="received-message">
          <image wx:if="{{item.avatarUrl}}" src="{{item.avatarUrl}}" class="avatar" mode="aspectFill" />
          <view wx:else class="avatar-placeholder">ğŸ‘¤</view>
          
          <view class="message-content">
            <view class="nickname">{{item.nickname}}</view>
            <!-- è¢«å›å¤çš„æ¶ˆæ¯ -->
            <view wx:if="{{item.replyToContent}}" class="reply-preview">
              <text class="reply-nickname">@{{item.replyToNickname}}</text>
              <text class="reply-content">: {{item.replyToContent}}</text>
            </view>
            <view class="bubble received-bubble" bindlongpress="onLongPressMessage" data-message-id="{{item.id}}" data-content="{{item.content}}" data-user-id="{{item.userId}}" data-is-translated="false">
              {{item.content}}
            </view>
            <view wx:if="{{item.translatedText}}" class="translated-text-container">
              <view class="translated-text" bindlongpress="onLongPressTranslatedMessage" data-message-id="{{item.id}}" data-content="{{item.translatedText}}" data-user-id="{{item.userId}}" data-is-translated="true">{{item.translatedText}}</view>
              <button class="speak-btn" bindtap="speakTranslatedText" data-message-id="{{item.id}}">ğŸ¤</button>
            </view>
            <view class="time">{{formatTime(item.createdAt)}}</view>
          </view>
        </view>
        
        <!-- å‘é€çš„æ¶ˆæ¯ -->
        <view wx:if="{{item.userId === currentUserId}}" class="sent-message">
          <view class="message-content">
            <!-- è¢«å›å¤çš„æ¶ˆæ¯ -->
            <view wx:if="{{item.replyToContent}}" class="reply-preview">
              <text class="reply-nickname">@{{item.replyToNickname}}</text>
              <text class="reply-content">: {{item.replyToContent}}</text>
            </view>
            <view class="bubble sent-bubble" bindlongpress="onLongPressMessage" data-message-id="{{item.id}}" data-content="{{item.content}}" data-user-id="{{item.userId}}" data-is-translated="false">
              {{item.content}}
            </view>
            <view wx:if="{{item.translatedText}}" class="translated-text-container">
              <view class="translated-text" bindlongpress="onLongPressTranslatedMessage" data-message-id="{{item.id}}" data-content="{{item.translatedText}}" data-user-id="{{item.userId}}" data-is-translated="true">{{item.translatedText}}</view>
              <button class="speak-btn" bindtap="speakTranslatedText" data-message-id="{{item.id}}">ğŸ¤</button>
            </view>
            <view class="time">{{formatTime(item.createdAt)}}</view>
          </view>
          
          <image wx:if="{{currentUserAvatar}}" src="{{currentUserAvatar}}" class="avatar" mode="aspectFill" />
          <view wx:else class="avatar-placeholder">ğŸ‘¤</view>
        </view>
      </view>
      
      <!-- åŠ è½½æ›´å¤šæç¤º -->
      <view wx:if="{{messages.length === 0}}" class="empty-hint">
        <text>æš‚æ— æ¶ˆæ¯ï¼Œå¼€å§‹èŠå¤©å§ï½</text>
      </view>
    </view>
  </scroll-view>

  <!-- è¾“å…¥æ¡† -->
  <view class="input-area">
    <view wx:if="{{replyingTo}}" class="reply-info">
      <text class="reply-label">å›å¤ @{{replyingToNickname}}</text>
      <text class="reply-close" bindtap="cancelReply">Ã—</text>
    </view>
    <view class="input-wrapper">
      <button class="at-btn" bindtap="showAtUserList">@</button>
      <input 
        type="text" 
        class="input-box" 
        placeholder="è¾“å…¥æ¶ˆæ¯..." 
        placeholder-class="input-placeholder"
        bindinput="onInput"
        value="{{inputContent}}"
        bindconfirm="sendMessage"
      />
      <button class="send-btn" bindtap="sendMessage">å‘é€</button>
    </view>
  </view>

  <!-- é•¿æŒ‰èœå• -->
  <view wx:if="{{showContextMenu}}" class="context-menu" bindtap="closeContextMenu">
    <view class="context-menu-content" catchtap="">
      <button class="context-menu-item" bindtap="replyMessage">å›å¤</button>
      <button class="context-menu-item" bindtap="translateMessage">ç¿»è¯‘</button>
      <button class="context-menu-item" bindtap="speakMessage">æœ—è¯µ</button>
      <button class="context-menu-item" bindtap="copyMessage">å¤åˆ¶</button>
      <button class="context-menu-item cancel" bindtap="closeContextMenu">å–æ¶ˆ</button>
    </view>
  </view>

  <!-- @ç”¨æˆ·åˆ—è¡¨ -->
  <view wx:if="{{showAtUserList}}" class="at-user-modal" bindtap="closeAtUserList">
    <view class="at-user-content" catchtap="">
      <view class="at-user-header">é€‰æ‹©è”ç³»äºº</view>
      <view class="at-user-list">
        <view 
          wx:for="{{onlineUsers}}" 
          wx:key="userId" 
          class="at-user-item" 
          bindtap="selectAtUser"
          data-user-id="{{item.userId}}"
          data-nickname="{{item.nickname}}"
        >
          <image wx:if="{{item.avatarUrl}}" src="{{item.avatarUrl}}" class="at-user-avatar" mode="aspectFill" />
          <view wx:else class="at-user-avatar-placeholder">ğŸ‘¤</view>
          <text class="at-user-name">{{item.nickname}}</text>
        </view>
      </view>
      <button class="at-cancel-btn" bindtap="closeAtUserList">å–æ¶ˆ</button>
    </view>
  </view>
</view>
