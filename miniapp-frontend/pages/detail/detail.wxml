<view class="container">
  <!-- åŠ è½½ä¸­çŠ¶æ€ -->
  <view wx:if="{{loading}}" class="loading-container">
    <text>åŠ è½½ä¸­...</text>
  </view>
  
  <!-- å•†å“å†…å®¹ -->
  <view class="content">
    <!-- å•†å“å›¾ç‰‡åŒºåŸŸï¼ˆå¸¦è¯„è®ºæŒ‰é’®ï¼‰ -->
    <view class="image-section">
      <swiper wx:if="{{imageList.length > 0}}" class="image-swiper" indicator-dots="{{imageList.length > 1}}" autoplay="{{false}}" circular="{{false}}" bindchange="onSwiperChange">
        <swiper-item wx:for="{{imageList}}" wx:key="index">
          <image mode="aspectFill" src="{{item}}" class="main-image" bindtap="previewImage" data-index="{{index}}"/>
        </swiper-item>
      </swiper>
      <image wx:elif="{{item.coverUrl}}" mode="aspectFill" src="{{item.coverUrl}}" class="main-image" bindtap="previewImage" data-index="0"/>
      <image wx:else mode="aspectFill" src="https://img.yzcdn.cn/vant/cat.jpeg" class="main-image"/>
      
      <!-- å³ä¸‹è§’æ”¶è—æŒ‰é’® -->
      <view wx:if="{{!isMyProduct}}" class="favorite-btn {{isFavorited ? 'favorited' : ''}}" catchtap="toggleFavorite">
        <text class="favorite-icon">{{isFavorited ? 'â¤ï¸' : 'ğŸ¤'}}</text>
      </view>
      
      <!-- å³ä¸‹è§’è¯„è®ºæŒ‰é’® -->
      <view class="comment-btn" catchtap="showCommentModal">
        <text class="comment-icon">ğŸ’¬</text>
        <text class="comment-count">{{comments.length}}</text>
      </view>
      
      <!-- å›¾ç‰‡æ•°é‡æŒ‡ç¤ºå™¨ -->
      <view wx:if="{{imageList.length > 1}}" class="image-indicator">{{currentImageIndex + 1}}/{{imageList.length}}</view>
    </view>

    <!-- å•†å“ä¿¡æ¯ -->
    <view class="info-section">
      <view class="title">{{item.name || 'å•†å“åç§°'}}</view>
      <view class="description">{{item.description}}</view>
      
      <view class="meta-row">
        <text class="meta-label">åˆ†ç±»ï¼š</text>
        <text class="meta-value">{{categoryName}}</text>
      </view>
      
      <view class="meta-row">
        <text class="meta-label">å‘å¸ƒæ—¶é—´ï¼š</text>
        <text class="meta-value">{{item.createdAt || 'åˆšåˆš'}}</text>
      </view>
    </view>

    <!-- å–å®¶ä¿¡æ¯ -->
    <view class="seller-section">
      <view class="seller-header">
        <image class="seller-avatar" src="{{sellerInfo.avatarUrl || 'https://img.yzcdn.cn/vant/cat.jpeg'}}" mode="aspectFill"/>
        <view class="seller-info">
          <view class="seller-name">{{sellerInfo.nickname || 'å–å®¶'}}</view>
          <view class="seller-tag">ä¸ªäººæ¨èè€…</view>
        </view>
        <view wx:if="{{!isMyProduct}}" class="contact-btn" catchtap="onChat">
          <text>è”ç³»</text>
        </view>
        <view wx:if="{{isMyProduct}}" class="edit-btn" catchtap="goEdit">
          <text>ç¼–è¾‘</text>
        </view>
      </view>
      
      <!-- å–å®¶è”ç³»æ–¹å¼ -->
      <view wx:if="{{sellerContact}}" class="seller-contact">
        <view wx:if="{{sellerContact.wechatId}}" class="contact-item">
          <text class="contact-label">å¾®ä¿¡ï¼š</text>
          <text class="contact-value">{{sellerContact.wechatId}}</text>
          <text class="copy-btn" bindtap="copyContact" data-type="wechat" data-value="{{sellerContact.wechatId}}">å¤åˆ¶</text>
        </view>
        <view wx:if="{{sellerContact.phone}}" class="contact-item">
          <text class="contact-label">æ‰‹æœºï¼š</text>
          <text class="contact-value">{{sellerContact.phone}}</text>
          <text class="copy-btn" bindtap="copyContact" data-type="phone" data-value="{{sellerContact.phone}}">å¤åˆ¶</text>
        </view>
        <view wx:if="{{sellerContact.email}}" class="contact-item">
          <text class="contact-label">é‚®ç®±ï¼š</text>
          <text class="contact-value">{{sellerContact.email}}</text>
          <text class="copy-btn" bindtap="copyContact" data-type="email" data-value="{{sellerContact.email}}">å¤åˆ¶</text>
        </view>
      </view>
    </view>
  </view>

  <!-- è¯„è®ºåˆ—è¡¨Modal -->
  <view wx:if="{{showCommentModal}}" class="modal-overlay" catchtap="hideCommentModal">
    <view class="modal-content" catchtap>
      <!-- Modalå¤´éƒ¨ -->
      <view class="modal-header">
        <text class="modal-title">è¯„è®º ({{comments.length}})</text>
        <text class="modal-close" bindtap="hideCommentModal">âœ•</text>
      </view>

      <!-- å‘è¡¨è¯„è®ºæŒ‰é’® -->
      <view class="comment-input-header">
        <button class="publish-btn" bindtap="togglePublishComment">å‘è¡¨è¯„è®º</button>
      </view>

      <!-- å‘è¡¨è¯„è®ºæ¡† -->
      <view wx:if="{{showPublishComment}}" class="comment-input-box">
        <view class="emotion-bar">
          <text class="emotion-label">è¡¨æƒ…ï¼š</text>
          <view class="emotion-list">
            <text wx:for="{{emotions}}" wx:key="*this" class="emotion-btn {{selectedEmotion === item ? 'selected' : ''}}" bindtap="onSelectEmotion" data-emotion="{{item}}">{{item}}</text>
          </view>
        </view>
        
        <!-- è¾“å…¥æ–¹å¼åˆ‡æ¢ -->
        <view class="input-mode-tabs">
          <view class="tab {{!showVoiceInput ? 'active' : ''}}" bindtap="switchInputMode" data-mode="text">âŒ¨ï¸ æ–‡å­—</view>
          <view class="tab {{showVoiceInput ? 'active' : ''}}" bindtap="switchInputMode" data-mode="voice">ğŸ¤ è¯­éŸ³</view>
        </view>
        
        <!-- æ–‡å­—è¾“å…¥ -->
        <view wx:if="{{!showVoiceInput}}">
          <textarea class="comment-input" placeholder="è¯´è¯´ä½ çš„æƒ³æ³•..." value="{{commentInput}}" bindchange="onCommentInput" maxlength="500"/>
        </view>
        
        <!-- è¯­éŸ³è¾“å…¥ï¼ˆæŒ‰ä½è¯´è¯ï¼‰ -->
        <view wx:if="{{showVoiceInput}}" class="voice-input-section">
          <view class="voice-record-btn {{isRecording ? 'recording' : ''}}" bindtouchstart="startRecording" bindtouchend="stopRecording">
            <text class="record-text">{{isRecording ? 'ğŸ”´ æ­£åœ¨å½•éŸ³... ' + recordingTime + 'ç§’' : 'ğŸ¤ æŒ‰ä½è¯´è¯'}}</text>
          </view>
          <view wx:if="{{commentInput}}" class="voice-preview">
            <text class="preview-label">å·²è¯†åˆ«æ–‡å­—ï¼š</text>
            <text class="preview-text">{{commentInput}}</text>
          </view>
        </view>
        
        <view class="input-actions">
          <button class="cancel-btn" bindtap="togglePublishComment">å–æ¶ˆ</button>
          <button class="submit-btn" bindtap="publishComment">å‘è¡¨</button>
        </view>
      </view>

      <!-- è¯„è®ºåˆ—è¡¨ -->
      <view class="comments-list">
        <view wx:if="{{comments.length === 0}}" class="empty-tip">æš‚æ— è¯„è®º</view>
        
        <view wx:for="{{comments}}" wx:key="id" class="comment-item" bindlongpress="showCommentMenu" data-comment-id="{{item.id}}">
          <!-- é•¿æŒ‰èœå• -->
          <view wx:if="{{contextMenu.visible && contextMenu.commentId === item.id}}" class="context-menu" style="top: {{contextMenu.y}}px; left: {{contextMenu.x}}px;">
            <view class="menu-item" bindtap="copyCommentText" data-text="{{item.content}}">å¤åˆ¶</view>
            <view class="menu-item" bindtap="toggleTranslate" data-comment-id="{{item.id}}">ç¿»è¯‘</view>
          </view>

          <!-- è¯„è®ºå†…å®¹ -->
          <image class="avatar" src="{{item.user.avatarUrl || 'https://img.yzcdn.cn/vant/cat.jpeg'}}"/>
          <view class="comment-main">
            <view class="user-name">{{item.user.nickname || 'ç”¨æˆ·'}}</view>
            <view class="comment-text">
              <text wx:if="{{item.emotion}}">{{item.emotion}} </text>
              <text>{{item.content}}</text>
            </view>
            
            <!-- ç¿»è¯‘ç»“æœ -->
            <view wx:if="{{expandedTranslateIds.indexOf(item.id) > -1 && item.translatedText}}" class="translate-box">
              <view class="translate-header">
                <text class="translate-label">è‹±æ–‡ç¿»è¯‘</text>
                <button class="play-voice-btn" bindtap="playTranslationVoice" data-comment-id="{{item.id}}" data-voice="female">ğŸ”Š å¥³å£°</button>
                <button class="play-voice-btn" bindtap="playTranslationVoice" data-comment-id="{{item.id}}" data-voice="male">ğŸ”Š ç”·å£°</button>
              </view>
              <text class="translate-text">{{item.translatedText}}</text>
            </view>

            <view class="comment-meta">
              <text class="comment-time">{{item.createdAt}}</text>
              <text class="like-btn" bindtap="likeComment" data-comment-id="{{item.id}}">ğŸ‘ {{item.likes}}</text>
            </view>
          </view>
        </view>
      </view>
    </view>
  </view>
</view>
