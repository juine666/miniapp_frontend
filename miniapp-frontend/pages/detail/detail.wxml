<view class="container">
  <!-- åŠ è½½ä¸­çŠ¶æ€ -->
  <view wx:if="{{loading}}" class="loading-container">
    <text>åŠ è½½ä¸­...</text>
  </view>
  
  <!-- å•†å“å†…å®¹ -->
  <view class="content">
    <!-- å•†å“å›¾ç‰‡åŒºåŸŸï¼ˆå¸¦è¯„è®ºæŒ‰é’®ï¼‰ -->
    <view class="image-section">
      <swiper wx:if="{{imageList.length > 0}}" class="image-swiper" indicator-dots="{{imageList.length > 1}}" autoplay="{{false}}" circular="{{false}}" bindchange="onSwiperChange">
        <swiper-item wx:for="{{imageList}}" wx:key="index">
          <image mode="aspectFill" src="{{item}}" class="main-image" bindtap="previewImage" data-index="{{index}}"/>
        </swiper-item>
      </swiper>
      <image wx:elif="{{item.coverUrl}}" mode="aspectFill" src="{{item.coverUrl}}" class="main-image" bindtap="previewImage" data-index="0"/>
      <image wx:else mode="aspectFill" src="https://img.yzcdn.cn/vant/cat.jpeg" class="main-image"/>
      
      <!-- å³ä¸‹è§’è¯„è®ºæŒ‰é’® -->
      <view class="comment-btn" catchtap="showCommentModal">
        <text class="comment-icon">ğŸ’¬</text>
        <text class="comment-count">{{totalCommentCount || comments.length}}</text>
      </view>
      
      <!-- å›¾ç‰‡æ•°é‡æŒ‡ç¤ºå™¨ -->
      <view wx:if="{{imageList.length > 1}}" class="image-indicator">{{currentImageIndex + 1}}/{{imageList.length}}</view>
    </view>

    <!-- å•†å“ä¿¡æ¯ -->
    <view class="info-section">
      <view class="title">{{item.name || 'å•†å“åç§°'}}</view>
      <view class="description">{{item.description}}</view>
      
      <view class="meta-row">
        <text class="meta-label">åˆ†ç±»ï¼š</text>
        <text class="meta-value">{{categoryName}}</text>
      </view>
      
      <view class="meta-row">
        <text class="meta-label">å‘å¸ƒæ—¶é—´ï¼š</text>
        <text class="meta-value">{{item.createdAt || 'åˆšåˆš'}}</text>
      </view>
    </view>

    <!-- å–å®¶ä¿¡æ¯ -->
    <view class="seller-section">
      <view class="seller-header">
        <image class="seller-avatar" src="{{sellerInfo.avatarUrl || 'https://img.yzcdn.cn/vant/cat.jpeg'}}" mode="aspectFill"/>
        <view class="seller-info">
          <view class="seller-name">{{sellerInfo.nickname || 'å–å®¶'}}</view>
          <view class="seller-tag">ä¸ªäººæ¨èè€…</view>
        </view>
        <view wx:if="{{!isMyProduct}}" class="contact-btn" catchtap="onChat">
          <text>è”ç³»</text>
        </view>
        <view wx:if="{{isMyProduct}}" class="edit-btn" catchtap="goEdit">
          <text>ç¼–è¾‘</text>
        </view>
      </view>
      
      <!-- å–å®¶è”ç³»æ–¹å¼ -->
      <view wx:if="{{sellerContact}}" class="seller-contact">
        <view wx:if="{{sellerContact.wechatId}}" class="contact-item">
          <text class="contact-label">å¾®ä¿¡ï¼š</text>
          <text class="contact-value">{{sellerContact.wechatId}}</text>
          <text class="copy-btn" bindtap="copyContact" data-type="wechat" data-value="{{sellerContact.wechatId}}">å¤åˆ¶</text>
        </view>
        <view wx:if="{{sellerContact.phone}}" class="contact-item">
          <text class="contact-label">æ‰‹æœºï¼š</text>
          <text class="contact-value">{{sellerContact.phone}}</text>
          <text class="copy-btn" bindtap="copyContact" data-type="phone" data-value="{{sellerContact.phone}}">å¤åˆ¶</text>
        </view>
        <view wx:if="{{sellerContact.email}}" class="contact-item">
          <text class="contact-label">é‚®ç®±ï¼š</text>
          <text class="contact-value">{{sellerContact.email}}</text>
          <text class="copy-btn" bindtap="copyContact" data-type="email" data-value="{{sellerContact.email}}">å¤åˆ¶</text>
        </view>
      </view>
    </view>
  </view>

  <!-- è¯„è®ºåˆ—è¡¨Modal -->
  <view wx:if="{{showCommentModal}}" class="modal-overlay" catchtap="hideCommentModal">
    <view class="modal-content" catchtap="noop">
      <!-- Modalå¤´éƒ¨ -->
      <view class="modal-header">
        <text class="modal-title">è¯„è®º ({{totalCommentCount || comments.length}})</text>
        <text class="modal-close" catchtap="hideCommentModal">âœ•</text>
      </view>

      <!-- è¯„è®ºåˆ—è¡¨ -->
      <view class="comments-list" bindscrolltoupper="onCommentsScrollTop" bindscrolltolower="onCommentsScrollBottom">
        <view wx:if="{{comments.length === 0}}" class="empty-tip">æš‚æ— è¯„è®º</view>
        
        <!-- éå†æ‰€æœ‰è¯„è®ºï¼Œæ¯ä¸ªè¯„è®ºåè·Ÿéšå…¶å›å¤ -->
        <view wx:for="{{comments}}" wx:key="id" class="comment-wrapper">
          <!-- ä¸€çº§è¯„è®º -->
          <view class="comment-item" bindlongpress="showCommentMenu" data-comment-id="{{item.id}}" catchtap="startReply" data-comment-id="{{item.id}}">
            <!-- é•¿æŒ‰èœå• -->
            <view wx:if="{{contextMenu.visible && contextMenu.commentId === item.id}}" class="context-menu" style="top: {{contextMenu.y}}px; left: {{contextMenu.x}}px;">
              <view class="menu-item" catchtap="copyCommentText" data-text="{{item.content}}">å¤åˆ¶</view>
              <view class="menu-item" catchtap="toggleTranslate" data-comment-id="{{item.id}}">ç¿»è¯‘</view>
            </view>

            <!-- è¯„è®ºå†…å®¹ -->
            <image class="avatar" src="{{item.user.avatarUrl || 'https://img.yzcdn.cn/vant/cat.jpeg'}}"/>
            <view class="comment-main">
              <view class="user-name">{{item.user.nickname || 'ç”¨æˆ·'}}</view>
              <view class="comment-text">
                <text wx:if="{{item.emotion}}">{{item.emotion}} </text>
                <text>{{item.content}}</text>
              </view>
              
              <!-- ç¿»è¯‘ç»“æœ -->
              <view wx:if="{{item.translatedText}}" class="translate-box">
                <view class="translate-header">
                  <text class="translate-label">è‹±æ–‡ç¿»è¯‘</text>
                </view>
                <text class="translate-text">{{item.translatedText}}</text>
              </view>

              <view class="comment-meta">
                <text class="comment-time">{{item.createdAt}}</text>
                <text class="like-btn" catchtap="likeComment" data-comment-id="{{item.id}}">ğŸ‘ {{item.likes}}</text>
                <text class="translate-btn" catchtap="translateComment" data-comment-id="{{item.id}}">ç¿»è¯‘</text>
                <text class="translate-voice-btn" catchtap="translateAndSpeak" data-comment-id="{{item.id}}">ğŸ”Š æœ—è¯µ</text>
              </view>
            </view>
          </view>
          
          <!-- äºŒçº§å›å¤åˆ—è¡¨ - åœ¨ä¸€çº§è¯„è®ºä¸‹æ–¹ -->
          <view wx:if="{{item.replies && item.replies.length > 0}}" class="replies-section">
            <!-- æ˜¾ç¤ºå‰2æ¡å›å¤æˆ–å…¨éƒ¨å›å¤ (ä½¿ç”¨item.displayRepliesæ§åˆ¶) -->
            <view wx:for="{{item.displayReplies || []}}" wx:key="id" class="reply-wrapper">
              <!-- äºŒçº§å›å¤ -->
              <view class="reply-item" catchtap="startReply" data-comment-id="{{item.id}}">
                <image class="avatar" src="{{item.user.avatarUrl || 'https://img.yzcdn.cn/vant/cat.jpeg'}}"/>
                <view class="comment-main">
                  <view class="user-name">{{item.user.nickname || 'ç”¨æˆ·'}}</view>
                  <view class="comment-text">{{item.content}}</view>
                  
                  <!-- ç¿»è¯‘ç»“æœ -->
                  <view wx:if="{{item.translatedText}}" class="translate-box">
                    <view class="translate-header">
                      <text class="translate-label">è‹±æ–‡ç¿»è¯‘</text>
                    </view>
                    <text class="translate-text">{{item.translatedText}}</text>
                  </view>
                  
                  <view class="comment-meta">
                    <text class="comment-time">{{item.createdAt}}</text>
                    <text class="like-btn" catchtap="likeComment" data-comment-id="{{item.id}}">ğŸ‘ {{item.likes}}</text>
                    <text class="translate-btn" catchtap="translateComment" data-comment-id="{{item.id}}">ç¿»è¯‘</text>
                    <text class="translate-voice-btn" catchtap="translateAndSpeak" data-comment-id="{{item.id}}">ğŸ”Š æœ—è¯µ</text>
                  </view>
                </view>
              </view>
            </view>
            
            <!-- ä¸‰çº§å›å¤ - å¹³è¡Œæ˜¾ç¤ºï¼Œä¸åœ¨reply-wrapperå†… -->
            <view wx:for="{{item.displayReplies || []}}" wx:key="id" wx:for-item="secondReply" class="third-level-replies">
              <view wx:if="{{secondReply.replies && secondReply.replies.length > 0}}" wx:for="{{secondReply.replies}}" wx:key="id" wx:for-item="thirdReply" class="third-reply-item" catchtap="startReply" data-comment-id="{{thirdReply.id}}">
                <image class="avatar" src="{{thirdReply.user.avatarUrl || 'https://img.yzcdn.cn/vant/cat.jpeg'}}"/>
                <view class="comment-main">
                  <view class="user-name">{{thirdReply.user.nickname || 'ç”¨æˆ·'}} <text wx:if="{{thirdReply.parentUser}}" class="reply-to">â€º {{thirdReply.parentUser.nickname || 'ç”¨æˆ·'}}</text></view>
                  <view class="comment-text">{{thirdReply.content}}</view>
                  
                  <view class="comment-meta">
                    <text class="comment-time">{{thirdReply.createdAt}}</text>
                    <text class="like-btn" catchtap="likeComment" data-comment-id="{{thirdReply.id}}">ğŸ‘ {{thirdReply.likes}}</text>
                    <text class="translate-btn" catchtap="translateComment" data-comment-id="{{thirdReply.id}}">ç¿»è¯‘</text>
                    <text class="translate-voice-btn" catchtap="translateAndSpeak" data-comment-id="{{thirdReply.id}}">ğŸ”Š æœ—è¯µ</text>
                  </view>
                </view>
              </view>
            </view>
            
            <!-- å±•å¼€å›å¤æŒ‰é’® - ä»…å½“æœªå±•å¼€ä¸”å›å¤æ€»æ•°>2æ—¶æ˜¾ç¤º -->
            <view wx:if="{{!expandedReplies[item.id] && item.replies.length > 2}}" class="expand-replies-btn" catchtap="toggleReplies" data-comment-id="{{item.id}}">
              <text>å±•å¼€ {{item.replies.length - 2}} æ¡å›å¤</text>
            </view>
            
            <!-- æŠ˜å æŒ‰é’® - ä»…å½“å·²å±•å¼€æ—¶æ˜¾ç¤º -->
            <view wx:if="{{expandedReplies[item.id] && item.replies.length > 2}}" class="expand-replies-btn collapse" catchtap="toggleReplies" data-comment-id="{{item.id}}">
              <text>æŠ˜å å›å¤</text>
            </view>
          </view>
        </view>
      </view>

      <!-- å‘è¡¨è¯„è®ºè¾“å…¥æ¡†ï¼ˆå›ºå®šåˆ°åº•éƒ¨ï¼‰ -->
      <view class="comment-input-footer">
        <!-- å‘è¡¨è¯„è®ºæŒ‰é’® -->
        <view wx:if="{{!showPublishComment}}" class="comment-input-header">
          <button class="publish-btn" catchtap="togglePublishComment">å‘è¡¨è¯„è®º</button>
        </view>

        <!-- å‘è¡¨è¯„è®ºæ¡† -->
        <view wx:if="{{showPublishComment}}" class="comment-input-box">
          <!-- è¾“å…¥æ–¹å¼åˆ‡æ¢ -->
          <view class="input-mode-tabs">
            <view class="tab {{!showVoiceInput ? 'active' : ''}}" catchtap="switchInputMode" data-mode="text">âŒ¨ï¸ æ–‡å­—</view>
            <view class="tab {{showVoiceInput ? 'active' : ''}}" catchtap="switchInputMode" data-mode="voice">ğŸ¤ è¯­éŸ³</view>
          </view>
          
          <!-- æ–‡å­—è¾“å…¥ - å¯Œæ–‡æœ¬ç¼–è¾‘å™¨ -->
          <view wx:if="{{!showVoiceInput}}" class="rich-editor-wrapper">
            <editor id="richEditor" class="rich-editor" placeholder="è¯´è¯´ä½ çš„æƒ³æ³•..." bindstatuschange="onEditorStatusChange" bindinput="onEditorInput"></editor>
            
            <!-- å¯Œæ–‡æœ¬å·¥å…·æ  -->
            <view class="editor-toolbar">
              <view class="toolbar-group">
                <text class="toolbar-btn" bindtap="formatText" data-format="bold" title="åŠ ç²—">B</text>
                <text class="toolbar-btn" bindtap="formatText" data-format="italic" title="æ–œä½“">I</text>
                <text class="toolbar-btn" bindtap="formatText" data-format="underline" title="ä¸‹åˆ’çº¿">U</text>
              </view>
              <view class="toolbar-group">
                <text class="toolbar-btn" bindtap="setTextColor" title="æ–‡å­—é¢œè‰²">ğŸ¨</text>
                <text class="toolbar-btn" bindtap="insertImage" title="æ’å…¥å›¾ç‰‡">ğŸ–¼ï¸</text>
              </view>
            </view>
          </view>
          
          <!-- è¯­éŸ³è¾“å…¥ï¼ˆæŒ‰ä½è¯´è¯ï¼‰ -->
          <view wx:if="{{showVoiceInput}}" class="voice-input-section">
            <view class="voice-record-btn {{isRecording ? 'recording' : ''}}" bindtouchstart="startRecording" bindtouchend="stopRecording">
              <text class="record-text">{{isRecording ? 'ğŸ”´ æ­£åœ¨å½•éŸ³... ' + recordingTime + 'ç§’' : 'ğŸ¤ æŒ‰ä½è¯´è¯'}}</text>
            </view>
            <view wx:if="{{commentInput}}" class="voice-preview">
              <text class="preview-label">å·²è¯†åˆ«æ–‡å­—ï¼š</text>
              <text class="preview-text">{{commentInput}}</text>
            </view>
          </view>
          
          <!-- æ“ä½œæŒ‰é’®ï¼ˆå§‹ç»ˆæ˜¾ç¤ºåœ¨åº•éƒ¨ï¼‰ -->
          <view class="input-actions">
            <button class="cancel-btn" catchtap="togglePublishComment">å–æ¶ˆ</button>
            <button class="submit-btn" catchtap="publishComment">å‘è¡¨</button>
          </view>
        </view>
      </view>
    </view>
  </view>
</view>
