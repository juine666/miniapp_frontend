# 微信小程序部署指南

## 📋 前置准备

### 1. 微信小程序账号
- 已注册微信小程序账号
- 获取小程序 AppID（在微信公众平台：开发 → 开发管理 → 开发设置）

### 2. 服务器端部署
- ✅ 后端API已部署到服务器
- ✅ 后端可以正常访问（例如：`https://your-domain.com` 或 `http://your-server-ip:8081`）

### 3. 开发工具
- 下载并安装微信开发者工具：https://developers.weixin.qq.com/miniprogram/dev/devtools/download.html

## 🚀 部署步骤

### 步骤1：配置后端API地址

1. 打开项目：`miniapp-frontend/app.js`
2. 修改 `baseURL` 为你的服务器地址：

```javascript
App({
  globalData: {
    baseURL: 'https://your-domain.com',  // 修改为你的服务器地址
    // 或者使用IP：'http://your-server-ip:8081'
    // 注意：如果使用IP，需要在微信公众平台配置服务器域名
    token: '',
    openid: '',
    // ...
  },
  // ...
});
```

**注意事项：**
- 如果使用HTTPS，URL必须是 `https://` 开头
- 如果使用HTTP，必须是配置在微信服务器域名白名单中的域名或IP
- 生产环境建议使用HTTPS + 域名

### 步骤2：配置小程序AppID

1. 打开 `miniapp-frontend/project.config.json`
2. 确认或修改 `appid`：

```json
{
  "appid": "wx0af23fd2a82b2553",  // 替换为你的小程序AppID
  "projectname": "stylemirror-miniapp",
  // ...
}
```

### 步骤3：配置服务器域名

1. 登录微信公众平台：https://mp.weixin.qq.com
2. 进入 **开发** → **开发管理** → **开发设置**
3. 找到 **服务器域名**，点击 **修改**
4. 配置以下域名：

```
request合法域名：
https://your-domain.com
或
http://your-server-ip:8081

uploadFile合法域名：
https://your-domain.com
或
http://your-server-ip:8081

downloadFile合法域名：
https://your-domain.com
或
http://your-server-ip:8081
```

**重要提示：**
- 域名必须通过ICP备案（国内服务器）
- 如果使用IP地址，需要勾选 **不校验合法域名**（仅开发环境）
- 生产环境必须使用HTTPS + 已备案域名

### 步骤4：配置业务域名（如果需要）

如果小程序中有H5页面或web-view组件：
1. 进入 **开发** → **开发管理** → **开发设置**
2. 找到 **业务域名**，添加你的域名
3. 下载验证文件，上传到服务器根目录

### 步骤5：使用微信开发者工具打开项目

1. 打开微信开发者工具
2. 选择 **小程序**
3. 点击 **+** 新建项目
4. 填写信息：
   - **项目名称**：StyleMirror
   - **目录**：选择 `miniapp-frontend` 目录
   - **AppID**：填写你的小程序AppID
   - **开发模式**：小程序
5. 点击 **新建**

### 步骤6：配置项目设置

1. 在微信开发者工具中，点击右上角 **详情**
2. **本地设置**：
   - ✅ 不校验合法域名（开发阶段）
   - ✅ 不校验TLS版本
   - ✅ 不校验HTTPS证书
3. **项目配置**：
   - 确认 AppID 正确
   - 确认项目名称

### 步骤7：编译和预览

1. 点击 **编译** 按钮（或快捷键 Ctrl+B / Cmd+B）
2. 检查是否有编译错误
3. 点击 **预览**，生成二维码
4. 用微信扫码在手机上测试

### 步骤8：真机调试

1. 点击 **真机调试**
2. 选择设备类型（iOS/Android）
3. 生成调试二维码
4. 用微信扫码在真机上调试
5. 查看控制台日志和网络请求

### 步骤9：上传代码

1. 点击 **上传** 按钮
2. 填写版本号（例如：1.0.0）
3. 填写项目备注（描述本次更新的内容）
4. 点击 **上传**

**上传信息示例：**
```
版本号：1.0.0
项目备注：
- 初始版本发布
- 支持商品发布、浏览、搜索
- 支持附近商品查找
- 支持用户收藏功能
```

### 步骤10：提交审核

1. 登录微信公众平台：https://mp.weixin.qq.com
2. 进入 **版本管理**
3. 找到刚才上传的版本，点击 **提交审核**
4. 填写审核信息：

**基本信息：**
- 版本描述：简要说明本次更新的功能
- 服务类目：选择合适的小程序类目（例如：生活服务 → 二手交易）

**提交审核：**
- 用户隐私保护指引：如果涉及用户信息收集，需要填写
- 测试账号：提供测试账号（如果需要登录）
- 测试路径：提供测试流程说明

**示例审核信息：**
```
版本描述：
StyleMirror二手商品交易小程序，支持用户发布、浏览、搜索商品，支持附近商品查找，支持用户收藏和消息功能。

服务类目：
生活服务 - 二手交易

测试账号：
（如果需要登录功能，提供测试账号）
```

### 步骤11：发布上线

1. 审核通过后，在 **版本管理** 中找到已审核通过的版本
2. 点击 **全量发布**
3. 确认发布
4. 发布成功后，用户可以在微信中搜索你的小程序使用

## 🔧 环境配置

### 开发环境配置

```javascript
// app.js - 开发环境
globalData: {
  baseURL: 'http://localhost:8081',  // 本地开发
  // 或
  baseURL: 'http://your-dev-server:8081',  // 开发服务器
}
```

### 生产环境配置

```javascript
// app.js - 生产环境
globalData: {
  baseURL: 'https://your-domain.com',  // 生产服务器（HTTPS）
}
```

### 多环境配置（推荐）

创建环境配置文件：

```javascript
// config/env.js
const ENV = {
  development: {
    baseURL: 'http://localhost:8081'
  },
  production: {
    baseURL: 'https://your-domain.com'
  }
};

const currentEnv = 'production'; // 发布时改为 production
module.exports = ENV[currentEnv];
```

```javascript
// app.js
const env = require('./config/env.js');

App({
  globalData: {
    baseURL: env.baseURL,
    // ...
  },
});
```

## 📝 发布前检查清单

### 代码检查
- [ ] 后端API地址已配置为生产环境地址
- [ ] AppID已配置正确
- [ ] 所有功能测试通过
- [ ] 没有编译错误和警告
- [ ] 控制台没有报错

### 配置检查
- [ ] 服务器域名已在微信公众平台配置
- [ ] 域名已通过ICP备案（如使用域名）
- [ ] HTTPS证书配置正确（如使用HTTPS）
- [ ] 后端服务正常运行

### 功能测试
- [ ] 用户登录功能正常
- [ ] 商品列表加载正常
- [ ] 商品详情页正常
- [ ] 发布商品功能正常
- [ ] 搜索功能正常
- [ ] 附近功能正常（需要位置权限）
- [ ] 收藏功能正常
- [ ] 消息功能正常

### 权限检查
- [ ] 位置权限已申请（用于附近功能）
- [ ] 相机权限已申请（用于拍照上传）
- [ ] 相册权限已申请（用于选择图片）

## 🔄 更新版本流程

### 1. 修改代码
```bash
# 修改代码后，在微信开发者工具中编译测试
```

### 2. 上传新版本
```
1. 点击"上传"
2. 版本号递增（如：1.0.0 → 1.0.1）
3. 填写更新说明
4. 上传
```

### 3. 提交审核
```
1. 在微信公众平台提交审核
2. 等待审核（通常1-3个工作日）
```

### 4. 发布
```
1. 审核通过后全量发布
2. 或使用灰度发布（部分用户先体验）
```

## 🐛 常见问题

### 1. 网络请求失败

**问题：** 小程序无法访问后端API

**解决方案：**
- 检查服务器域名是否配置在微信公众平台
- 检查后端服务是否正常运行
- 检查baseURL配置是否正确
- 开发阶段可以勾选"不校验合法域名"

### 2. 登录失败

**问题：** 微信登录无法获取用户信息

**解决方案：**
- 检查微信小程序AppID和Secret是否正确
- 检查后端登录接口是否正常
- 检查服务器域名配置

### 3. 位置功能无法使用

**问题：** 附近功能无法获取位置

**解决方案：**
- 检查是否申请了位置权限
- 检查 `app.json` 中是否配置了权限说明
- 检查小程序设置中是否授权位置权限

### 4. 图片上传失败

**问题：** 上传商品图片失败

**解决方案：**
- 检查OSS配置是否正确
- 检查uploadFile合法域名是否配置
- 检查图片大小是否超过限制

### 5. 编译错误

**问题：** 微信开发者工具编译报错

**解决方案：**
- 检查代码语法错误
- 检查是否有未使用的变量
- 检查路径是否正确
- 清除缓存后重新编译

## 📱 小程序配置说明

### app.json 关键配置

```json
{
  "pages": [...],  // 页面路径
  "window": {
    "navigationBarTitleText": "StyleMirror",  // 导航栏标题
    "navigationBarBackgroundColor": "#ffffff"  // 导航栏背景色
  },
  "tabBar": {
    "custom": true,  // 使用自定义tabBar
    // ...
  },
  "permission": {
    "scope.userLocation": {
      "desc": "用于展示附近的二手商品"  // 位置权限说明
    }
  }
}
```

### 自定义tabBar配置

如果使用自定义tabBar，需要：
1. 创建 `custom-tab-bar` 目录
2. 配置 `app.json` 中 `tabBar.custom: true`
3. 实现自定义tabBar组件

## 🔒 安全建议

1. **API安全**
   - 使用HTTPS传输
   - 后端验证所有请求
   - 使用JWT token认证

2. **数据安全**
   - 敏感信息不要存储在小程序本地
   - 用户密码等敏感操作在后端处理

3. **隐私保护**
   - 明确告知用户数据收集用途
   - 遵守微信小程序隐私保护指引

## 📊 版本管理建议

### 版本号规则
- 主版本号.次版本号.修订号（如：1.0.0）
- 主版本：重大功能更新
- 次版本：新功能添加
- 修订号：bug修复

### 版本记录
建议记录每个版本的更新内容：
```
1.0.0 - 初始版本
  - 商品发布、浏览功能
  - 搜索、附近功能
  - 用户收藏功能

1.1.0 - 新增功能
  - 添加消息功能
  - 优化商品列表展示
```

## 🎯 快速部署检查

部署前确认：
1. ✅ 后端API地址已配置（app.js）
2. ✅ 小程序AppID已配置（project.config.json）
3. ✅ 服务器域名已配置（微信公众平台）
4. ✅ 代码已编译无错误
5. ✅ 功能测试通过
6. ✅ 代码已上传
7. ✅ 已提交审核

部署完成后的验证：
1. ✅ 小程序可以正常打开
2. ✅ 可以正常登录
3. ✅ 商品列表可以正常加载
4. ✅ 主要功能可以正常使用

