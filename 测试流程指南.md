# 完整流程测试指南

本文档提供从登录到购买的完整测试流程。

## 📋 前置准备

### 1. 启动后端服务

```bash
# 进入后端目录
cd miniapp-backend

# 方式1：前台运行（推荐，可以看到实时日志）
./gradlew bootRun -x test

# 方式2：后台运行
./gradlew bootRun -x test &

# 方式3：使用脚本（前台运行）
bash 前台运行.sh

# 检查服务是否启动成功
# 看到类似以下日志表示启动成功：
# Started MiniappBackendApplication in X.XXX seconds
```

**验证后端启动**：
- 浏览器访问：http://localhost:8081/api/categories
- 应该返回分类列表的JSON数据

### 2. 启动微信小程序

1. 打开微信开发者工具
2. 导入项目：选择 `miniapp-frontend` 目录
3. 配置AppID（可使用测试号）
4. 编译并运行

---

## 🔐 第一步：登录

### 操作步骤：

1. **进入"我的"页面**
   - 在小程序底部导航栏点击"我的"

2. **点击"登录"按钮**
   - 如果未登录，会显示登录提示
   - 点击"登录"按钮

3. **授权登录**
   - 微信会弹出授权弹窗
   - 点击"允许"获取昵称和头像
   - 如果没有弹窗，在开发者工具中可能需要手动模拟授权

4. **验证登录成功**
   - 登录后，"我的"页面应该显示：
     - 你的微信头像和昵称
     - "设置"和"退出"按钮
     - 统计数据（收藏数、发布数、订单数）

### ✅ 预期结果：

- ✅ 头像和昵称显示正确
- ✅ 页面不再显示"请先登录"提示
- ✅ 后端日志显示登录成功

---

## 📝 第二步：发布商品

### 操作步骤：

1. **进入发布页面**
   - 方式1：底部导航栏点击"发布"
   - 方式2：首页右下角点击"＋发布"悬浮按钮

2. **上传商品图片**
   - 点击图片区域（带"+"号的区域）
   - 从相册选择一张图片
   - 等待图片压缩和上传（会显示"压缩图片中..."、"上传中..."）
   - ✅ 上传成功后，图片应该立即显示在页面上

3. **填写商品信息**
   - **标题**（必填）：例如 "二手iPhone 12"
   - **详细说明**（选填）：例如 "9成新，功能完好，原装充电器"
   - **价格**（必填）：例如输入 `2500`（单位：元）

4. **发布商品**
   - 点击"发布闲置"按钮
   - 看到"已发布"提示
   - 自动返回上一页

### ✅ 预期结果：

- ✅ 图片上传成功并显示在发布页
- ✅ 发布成功后看到提示
- ✅ 在"我的"页面 → "我发布的"标签页能看到刚发布的商品
- ✅ 在首页商品列表中能看到刚发布的商品

### 🐛 常见问题：

**问题1：图片上传后页面没有显示**
- 解决：检查控制台日志，查看图片URL是否正确
- 检查：`form.coverUrl` 是否有值

**问题2：发布失败**
- 检查：标题和价格是否都填写了
- 检查：后端服务是否正常运行
- 查看：后端日志中的错误信息

---

## ❤️ 第三步：收藏商品

### 操作步骤：

1. **进入首页**
   - 底部导航栏点击"首页"

2. **浏览商品列表**
   - 可以看到所有发布的商品
   - 每个商品卡片右上角有两个按钮：
     - 📤 分享按钮（上方）
     - 🤍/❤️ 收藏按钮（下方）

3. **收藏商品**
   - 点击商品卡片右上角的 🤍 收藏按钮
   - 看到"已收藏"提示
   - 按钮变成 ❤️（红色）

4. **查看我的收藏**
   - 进入"我的"页面
   - 点击"我的收藏"按钮
   - 应该能看到刚收藏的商品

### ✅ 预期结果：

- ✅ 收藏按钮从 🤍 变成 ❤️
- ✅ 看到"已收藏"提示
- ✅ "我的收藏"页面显示该商品

### 🔄 取消收藏：

- 再次点击 ❤️ 按钮
- 看到"已取消收藏"提示
- 按钮变回 🤍

---

## 💰 第四步：购买流程

### 操作步骤：

1. **查看商品详情**
   - 在首页点击任意商品卡片
   - 进入商品详情页

2. **确认商品信息**
   - 查看商品图片、标题、价格、描述
   - 查看卖家信息

3. **点击"我想要"按钮**
   - 商品详情页底部有"和卖家聊一聊"和"我想要"按钮
   - 点击"我想要"按钮

4. **创建订单**
   - 系统自动创建订单
   - 可能弹出支付窗口（如果配置了微信支付）
   - 或者显示订单创建成功

### ✅ 预期结果：

- ✅ 订单创建成功
- ✅ 在"我的"页面 → "我买到的"标签页能看到订单
- ✅ 在"订单"页面能看到订单列表

### ⚠️ 注意：

**微信支付**：
- 微信支付需要在微信小程序后台配置，开发者工具中可能无法真实支付
- 在开发者工具中，支付会显示"支付发起"，但不完成真实支付
- 订单状态可能为"CREATED"（待支付）或"PAID"（已支付）

**订单状态**：
- `CREATED`: 订单已创建，待支付
- `PAID`: 已支付
- `SHIPPED`: 已发货
- `COMPLETED`: 已完成

---

## 🧪 完整测试清单

### 登录流程
- [ ] 未登录时进入"我的"页面，显示登录提示
- [ ] 点击登录，授权成功
- [ ] 登录后显示用户头像和昵称
- [ ] 登录后"设置"和"退出"按钮可见

### 发布流程
- [ ] 能进入发布页面
- [ ] 能选择并上传图片
- [ ] 图片上传后立即显示在页面
- [ ] 填写标题、描述、价格
- [ ] 发布成功，显示提示
- [ ] 发布后能在"我发布的"看到商品
- [ ] 发布后能在首页看到商品

### 收藏流程
- [ ] 在首页能看到商品列表
- [ ] 点击收藏按钮，从 🤍 变成 ❤️
- [ ] 显示"已收藏"提示
- [ ] 在"我的收藏"能看到收藏的商品
- [ ] 取消收藏，按钮变回 🤍

### 购买流程
- [ ] 能进入商品详情页
- [ ] 详情页显示完整的商品信息
- [ ] 点击"我想要"创建订单
- [ ] 在"我买到的"看到订单
- [ ] 在"订单"页面看到订单列表

### 额外功能
- [ ] 分享功能：点击分享按钮，跳转到分享页面
- [ ] 聊天功能：点击"和卖家聊一聊"，进入聊天页面
- [ ] 商品管理：在"我的"页面能看到"我发布的"、"我卖出的"、"我买到的"

---

## 🐛 调试技巧

### 查看前端日志

1. **微信开发者工具**
   - 打开"调试器"面板
   - 查看"Console"标签页
   - 所有 `console.log` 会在这里显示

2. **查看请求**
   - 打开"Network"标签页
   - 可以看到所有API请求
   - 查看请求和响应内容

### 查看后端日志

1. **前台运行**（推荐）
   ```bash
   cd miniapp-backend
   ./gradlew bootRun -x test
   ```
   - 所有日志直接显示在终端

2. **查看日志文件**
   ```bash
   cd miniapp-backend
   tail -f logs/miniapp-backend.log
   ```

3. **SQL日志**
   - 后端已配置SQL日志输出
   - 可以看到完整的SQL语句和参数
   - 格式：`==> Parameters: 1(Long)`

### 常见错误排查

1. **网络错误（连接失败）**
   - 检查后端服务是否启动
   - 检查 `app.js` 中的 `baseURL` 是否正确（`http://localhost:8081`）
   - 如果在真机测试，需要将 `localhost` 改为本机IP地址

2. **403 Forbidden**
   - 检查后端 `SecurityConfig` 是否允许该API路径
   - 查看后端日志中的安全配置

3. **登录失败**
   - 在开发者工具中，登录会使用mock模式
   - 检查后端日志中的登录信息
   - 如果是真机测试，需要配置真实的微信AppID和Secret

4. **图片上传失败**
   - 检查OSS配置是否正确
   - 检查网络连接
   - 查看控制台中的错误信息

---

## 📱 真机测试注意事项

如果要使用真机测试：

1. **修改 baseURL**
   ```javascript
   // app.js
   globalData: {
     baseURL: 'http://192.168.1.XXX:8081',  // 改为你的本机IP
   }
   ```

2. **确保手机和电脑在同一局域网**

3. **配置微信小程序AppID**
   - 需要在微信小程序后台配置服务器域名
   - 将你的后端域名添加到"request合法域名"

4. **关闭防火墙**（如果需要）

---

## 🎯 快速测试脚本

```bash
# 1. 启动后端（新终端窗口）
cd miniapp-backend
./gradlew bootRun -x test

# 2. 检查后端是否启动（另一个终端）
curl http://localhost:8081/api/categories

# 3. 查看日志
tail -f miniapp-backend/logs/miniapp-backend.log
```

---

## 📝 测试记录表

| 测试项 | 结果 | 备注 |
|--------|------|------|
| 登录功能 | ☐ 通过 |  |
| 发布商品 | ☐ 通过 |  |
| 图片上传 | ☐ 通过 |  |
| 收藏商品 | ☐ 通过 |  |
| 取消收藏 | ☐ 通过 |  |
| 查看详情 | ☐ 通过 |  |
| 创建订单 | ☐ 通过 |  |
| 分享功能 | ☐ 通过 |  |
| 聊天功能 | ☐ 通过 |  |

---

祝测试顺利！如有问题，请查看日志文件或联系开发人员。

